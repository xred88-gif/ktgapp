<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bidding</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root { --bg:#0b1220; --panel:#121a2b; --ink:#e7ecf8; --muted:#9fb0d3; --accent:#7aa2ff; --ok:#2ecc71; --warn:#ffb020; --gray:#2d364a; }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    background: var(--bg);
    color: var(--ink);
  }
  .wrap{ max-width: 980px; margin: 40px auto; padding: 24px; }
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  }
  h1{ font-size:28px; margin:0 0 12px; }
  .help{ color: var(--muted); margin: 6px 0 16px; }
  .small{ font-size:12px; color: var(--muted); }
  label{ display:block; font-weight:600; margin:12px 0 6px; }
  input[type="file"], select, button, textarea{
    width:100%; padding:12px 14px; border-radius:12px;
    border:1px solid rgba(255,255,255,0.12); background:#0f1626; color:var(--ink);
  }
  textarea{ resize:vertical; min-height:180px; }
  .btn{ cursor:pointer; font-weight:700; border:none; }
  .btn.primary{ background: linear-gradient(90deg, #5a82ff, #7aa2ff); }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .mt{ margin-top:14px; }
  .status{ display:flex; gap:10px; align-items:center; margin-top:12px; color:var(--muted); }
  .dot{ width:10px; height:10px; border-radius:50%; background: var(--warn); }
  .dot.ok{ background: var(--ok); }
  .onecol{ display:block; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ðŸ“Š Amazon Bidding Report Creator</h1>
    <p class="help">Upload all Excel files at once. Assign each file to a role and click <strong>Proceed</strong> to produce <code>bidding.xlsx</code>.</p>

    <label>Upload all Excel files</label>
    <input id="allFiles" type="file" accept=".xlsx,.xls" multiple />
    <div id="fileAssignments" class="row mt"></div>

    <div class="onecol mt">
      <label>Control thresholds</label>
      <div class="row">
        <div><label class="small">Bleeder min clicks (no-sales)</label><input id="thClicksNoSales" type="number" value="7" /></div>
        <div><label class="small">Low clicks threshold</label><input id="thLowClicks" type="number" value="2" /></div>
      </div>
      <div class="row mt">
        <div><label class="small">High ACOS threshold (%)</label><input id="thHighAcos" type="number" value="35" /></div>
        <div><label class="small">Good/Low ACOS max (%)</label><input id="thLowAcos" type="number" value="20" /></div>
      </div>
      <p class="small">These values drive: bleeders (clicks â‰¥ X &amp; sales = 0), high ACOS (&gt; %), good ACOS (â‰¤ %), and low clicks (&lt; X).</p>
    </div>

    <div class="row mt">
      <div><button id="proceed" class="btn primary">Proceed</button></div>
      <div class="status"><span class="dot" id="statusDot"></span><span id="status"></span></div>
    </div>

    <h3 class="mt">Log data</h3>
    <textarea id="log" readonly></textarea>
  </div>
</div>

<script>
function setStatus(msg, ok){ document.getElementById('status').textContent=msg; const dot=document.getElementById('statusDot'); ok?dot.classList.add('ok'):dot.classList.remove('ok'); }
function log(msg){ const t=document.getElementById('log'); t.value+=(t.value?"\n":"")+msg; t.scrollTop=t.scrollHeight; }

function formatDate(v){
  if (!v) return '';
  if (v instanceof Date && !isNaN(v)) return v.toISOString().slice(0,10);
  if (typeof v === 'number' && isFinite(v)) {
    const d = new Date(Math.round((v - 25569) * 86400 * 1000));
    return isNaN(d) ? '' : d.toISOString().slice(0,10);
  }
  const d = new Date(v);
  return isNaN(d) ? '' : d.toISOString().slice(0,10);
}

// --- UPDATED num(): universal numeric/currency parser ---
// Handles: US$22.36, $22.36, US22.36, 22.36, (22.36), 1,234.56, etc.
function num(v){
  if (v == null) return 0;
  if (typeof v === 'number') return v || 0;
  let s = String(v).trim();
  // Parentheses negatives: (123.45) -> -123.45
  let neg = false;
  if (/^\(.*\)$/.test(s)) { neg = true; s = s.slice(1, -1); }
  // Remove EVERYTHING except digits, dot, minus (strips currency codes/symbols, spaces, commas, %)
  s = s.replace(/[^0-9.\-]/g, '');
  if (!s) return 0;
  const n = parseFloat(s);
  return isNaN(n) ? 0 : (neg ? -n : n);
}

// stronger normalization (handles NBSP & quotes)
function normName(v){
  return String(v||'')
    .replace(/\u00A0/g,' ')        // NBSP -> space
    .replace(/\s+/g,' ')
    .replace(/["'â€™`]+/g,'')        // strip quotes
    .toLowerCase()
    .trim();
}

// pick first non-empty among aliases
function pick(row, names){
  for (const n of names){
    if (row && row[n] != null && row[n] !== '') return row[n];
  }
  return '';
}

// campaign/spend getters for DAILY files
function getCampaign(row){
  return pick(row, ['Campaigns','Campaign','Campaign Name','Campaign name','Campaign ID','Campaign Id','Campaign Title']);
}
function getSpend(row){
  return pick(row, ['Spend','Spend (USD)','Cost','Total Spend','Attributed Spend']);
}

// Normalize percent-like inputs to a 0â€“1 fraction
function toPct01(v){
  let n = num(v);
  if (!isFinite(n) || n <= 0) return 0;
  return n >= 10 ? n/100 : n;
}

const ROLES=['Campaigns 30 Days','Campaigns 7 Days','Day Before Yesterday','Yesterday'];
const fileInput=document.getElementById('allFiles');

function syncExclusiveSelections(){
  const selects=[...document.querySelectorAll('#fileAssignments select[multiple]')];
  const selectedElse=new Set();
  selects.forEach(s=>[...s.selectedOptions].forEach(o=>selectedElse.add(o.value)));
  selects.forEach(s=>{
    const own=new Set([...s.selectedOptions].map(o=>o.value));
    [...s.options].forEach(o=>o.disabled=selectedElse.has(o.value)&&!own.has(o.value));
    s.classList.toggle('has-selection',own.size>0);
  });
}

fileInput.addEventListener('change',()=>{
  const files=[...fileInput.files]; const container=document.getElementById('fileAssignments'); container.innerHTML='';
  ROLES.forEach(r=>{
    const wrap=document.createElement('div'); const lab=document.createElement('label'); lab.textContent=r;
    const sel=document.createElement('select'); sel.multiple=true; sel.dataset.role=r;
    sel.addEventListener('change',syncExclusiveSelections);
    files.forEach((f,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=f.name; sel.appendChild(o);});
    wrap.appendChild(lab); wrap.appendChild(sel); container.appendChild(wrap);
  });
  syncExclusiveSelections();
});

function readFileAsync(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res({data:r.result,name:f.name});r.onerror=e=>rej(e);r.readAsArrayBuffer(f);});}

// Auto-pick the sheet that actually has a Campaign column (for DAILY files)
function readMultipleDaily(fs){
  return (async () => {
    const rows = [];
    for (const f of fs || []){
      try{
        const {data} = await readFileAsync(f);
        const wb = XLSX.read(data, {type:'array', cellDates:true});
        let picked = wb.SheetNames[0];
        for (const nm of wb.SheetNames){
          const hdrProbe = XLSX.utils.sheet_to_json(wb.Sheets[nm], {header:1, defval:''});
          const headers = (hdrProbe[0]||[]).map(h => String(h||'').toLowerCase());
          if (headers.some(h => h.includes('campaign'))) { picked = nm; break; }
        }
        const sheet = wb.Sheets[picked];
        const sh = XLSX.utils.sheet_to_json(sheet, {defval:'', raw:false, dateNF:'yyyy-mm-dd'});
        rows.push(...sh);
        log(`Daily: read ${sh.length} rows from "${f.name}" sheet "${picked}"`);
      }catch(e){
        log(`Failed ${f.name}: ${e}`);
      }
    }
    return rows;
  })();
}

async function proceed(){
  setStatus('Working...'); log('Start processing');
  try{
    const selects=document.querySelectorAll('#fileAssignments select'); const all=fileInput.files; const filesMap={};
    selects.forEach(s=>{const idxs=[...s.selectedOptions].map(o=>o.value); if(idxs.length)filesMap[s.dataset.role]=idxs.map(i=>all[i]);});
    if(!filesMap['Campaigns 30 Days']) throw new Error('Campaigns 30 Days not assigned.');

    // Reader for non-daily files (first sheet)
    async function readMultiple(fs){
      const a=[];
      for(const f of fs||[]){
        try{
          const {data}=await readFileAsync(f);
          const wb=XLSX.read(data, {type:'array', cellDates: true});
          const sh=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:'', raw:false, dateNF:'yyyy-mm-dd'});
          a.push(...sh);
        }catch(e){ log(`Failed ${f.name}: ${e}`); }
      }
      return a;
    }

    const d30 = await readMultiple(filesMap['Campaigns 30 Days']);
    const d7  = await readMultiple(filesMap['Campaigns 7 Days']);
    const db  = await readMultipleDaily(filesMap['Day Before Yesterday']); // daily: auto-pick sheet
    const y   = await readMultipleDaily(filesMap['Yesterday']);            // daily: auto-pick sheet

    const TH={clicksNoSales:+thClicksNoSales.value||7,highAcos:(+thHighAcos.value||35)/100,lowAcos:(+thLowAcos.value||20)/100,lowClicks:+thLowClicks.value||2};

    // 7-day map (unchanged)
    const map7 = {};
    d7.forEach(r => map7[normName(r['Campaigns'])] = r);

    // Summed spend maps for DBY and Y by campaign
    const spendDB = {};
    db.forEach(r => {
      const k = normName(getCampaign(r));
      if (!k) return;
      const s = num(getSpend(r));       // now robust to US$, $, letters, commas, etc.
      spendDB[k] = (spendDB[k] || 0) + s;
    });

    const spendY = {};
    y.forEach(r => {
      const k = normName(getCampaign(r));
      if (!k) return;
      const s = num(getSpend(r));       // same robust parsing
      spendY[k] = (spendY[k] || 0) + s;
    });

    const out=[];
    d30.forEach(r=>{
      const k = normName(r['Campaigns']);
      const r7 = map7[k] || {};

      const row={
        'Campaigns': r['Campaigns']||'',
        'Start date': formatDate(r['Start date'] || r['Start Date'] || r['StartDate']),
        'Portfolio': r['Portfolio']||r['Portifolio']||'',
        'Budget': r['Budget']||0,

        'Impressions_30days': r['Impressions']||0,
        'Clicks_30days': r['Clicks']||0,
        'Spend_30days': r['Spend']||0,
        'Orders_30days': r['Orders']||0,
        'Sales_30days': r['Sales']||0,
        'ACOS_30days': toPct01(r['ACOS']),

        'Last 7 Days':'',
        'Impressions_7days': num(r7['Impressions']),
        'Clicks_7days':      num(r7['Clicks']),
        'Spend_7days':       num(r7['Spend']),
        'Orders_7days':      num(r7['Orders']),
        'Sales_7days':       num(r7['Sales']),
        'ACOS_7days':        toPct01(r7['ACOS']),

        'Spent_DayBeforeYesterday': spendDB[k] || 0,
        'Spent_Yesterday':          spendY[k]  || 0
      };

      if (!(k in spendDB)) log(`No DBY spend found for: ${r['Campaigns']}`);
      if (!(k in spendY))  log(`No Y spend found for: ${r['Campaigns']}`);

      const clicks7 = +row['Clicks_7days'],
            sales7  = +row['Sales_7days'],
            acos7   = +row['ACOS_7days'];

      row['Budget Check'] = '';
      row['Lower bids for Bleeders w/ no Sales'] = (clicks7 >= TH.clicksNoSales && sales7 === 0) ? 'TRUE' : 'FALSE';
      row['Lower bids for targets w/ ACOS higher than'] = (acos7 > TH.highAcos) ? TH.highAcos : '';
      row['Increase bids to Targets w/ Low Clicks'] = (clicks7 < TH.lowClicks) ? '3%' : '';
      row['Increase bids for Targets with good ACOS'] = (acos7 > 0 && acos7 <= TH.lowAcos) ? '3%' : '';
      row['Crateria: Good ACOS'] = (acos7 > 0 && acos7 < TH.lowAcos) ? TH.lowAcos : '';
      row['Change Campaign Budget'] = r['Change Campaign Budget'] || '';

      out.push(row);
    });

    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.json_to_sheet(out);
    const wsRange=XLSX.utils.decode_range(ws['!ref']);
    const headers=Object.keys(out[0]||{});
    const headerMap={}; headers.forEach((h,i)=>headerMap[h]=i);

    function fmt(col){
      if(!(col in headerMap))return;
      const c=XLSX.utils.encode_col(headerMap[col]);
      for(let R=1;R<=wsRange.e.r;R++){
        const a=c+(R+1);
        const cell=ws[a];
        if(cell&&typeof cell.v==='number'){cell.t='n';cell.z='0.00%';}
      }
    }
    ['ACOS_30days','ACOS_7days','Lower bids for targets w/ ACOS higher than','Crateria: Good ACOS'].forEach(fmt);

    XLSX.utils.book_append_sheet(wb,ws,'Bidding');
    XLSX.writeFile(wb,'bidding.xlsx');
    setStatus('Done â€” bidding.xlsx downloaded',true);
    log('Export completed');
  }catch(e){
    log('Error: '+e.message);
    setStatus('Error');
  }
}
document.getElementById('proceed').addEventListener('click',proceed);
</script>
</body>
</html>
