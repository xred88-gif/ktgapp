<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bidding</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root { --bg:#0b1220; --panel:#121a2b; --ink:#e7ecf8; --muted:#9fb0d3; --accent:#7aa2ff; --ok:#2ecc71; --warn:#ffb020; --gray:#2d364a; }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    background: var(--bg);
    color: var(--ink);
  }
  .wrap{ max-width: 980px; margin: 40px auto; padding: 24px; }
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  }
  h1{ font-size:28px; margin:0 0 12px; }
  .help{ color: var(--muted); margin: 6px 0 16px; }
  .small{ font-size:12px; color: var(--muted); }
  label{ display:block; font-weight:600; margin:12px 0 6px; }
  input[type="file"], select, button, textarea{
    width:100%; padding:12px 14px; border-radius:12px;
    border:1px solid rgba(255,255,255,0.12); background:#0f1626; color:var(--ink);
  }
  textarea{ resize:vertical; min-height:180px; }
  .btn{ cursor:pointer; font-weight:700; border:none; }
  .btn.primary{ background: linear-gradient(90deg, #5a82ff, #7aa2ff); }
  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .mt{ margin-top:14px; }
  .status{ display:flex; gap:10px; align-items:center; margin-top:12px; color:var(--muted); }
  .dot{ width:10px; height:10px; border-radius:50%; background: var(--warn); }
  .dot.ok{ background: var(--ok); }
  footer{ margin-top:24px; color:var(--muted); font-size:12px; text-align:center; }
  code { background:#0f1626; padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.08); }

  select[multiple] option:checked{ background: var(--gray) !important; color:#e7ecf8 !important; }
  select.has-selection{ border-color: rgba(255,255,255,0.25); background:#0e1524; }
  select[multiple] option:disabled{ background: var(--gray) !important; color:#9aa7c2 !important; opacity:0.8; }
  .onecol{ display:block; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ðŸ“Š Amazon Bidding Report Creator</h1>
    <p class="help">Upload all Excel files at once. Assign each file to a role and click <strong>Proceed</strong> to produce <code>bidding.xlsx</code>.</p>

    <label>Upload all Excel files</label>
    <input id="allFiles" type="file" accept=".xlsx,.xls" multiple />
    <div id="fileAssignments" class="row mt"></div>

    <div class="onecol mt">
      <label>Control thresholds</label>
      <div class="row">
        <div><label class="small">Bleeder min clicks (no-sales)</label><input id="thClicksNoSales" type="number" value="7" /></div>
        <div><label class="small">Low clicks threshold</label><input id="thLowClicks" type="number" value="2" /></div>
      </div>
      <div class="row mt">
        <div><label class="small">High ACOS threshold (%)</label><input id="thHighAcos" type="number" value="35" /></div>
        <div><label class="small">Good/Low ACOS max (%)</label><input id="thLowAcos" type="number" value="20" /></div>
      </div>
      <p class="small">These values drive: bleeders (clicks â‰¥ X &amp; sales = 0), high ACOS (&gt; %), good ACOS (â‰¤ %), and low clicks (&lt; X).</p>
    </div>

    <div class="row mt">
      <div><button id="proceed" class="btn primary">Proceed</button></div>
      <div class="status"><span class="dot" id="statusDot"></span><span id="status"></span></div>
    </div>

    <h3 class="mt">Log data</h3>
    <textarea id="log" readonly></textarea>
  </div>
</div>

<script>
function setStatus(msg, ok){ document.getElementById('status').textContent=msg; const dot=document.getElementById('statusDot'); ok?dot.classList.add('ok'):dot.classList.remove('ok'); }
function log(msg){ const t=document.getElementById('log'); t.value+=(t.value?"\n":"")+msg; t.scrollTop=t.scrollHeight; }
function formatDate(v){
  if (!v) return '';
  // Already a Date
  if (v instanceof Date && !isNaN(v)) {
    return v.toISOString().slice(0,10);
  }
  // Excel serial number (1 = 1900-01-01; 25569 = 1970-01-01)
  if (typeof v === 'number' && isFinite(v)) {
    const d = new Date(Math.round((v - 25569) * 86400 * 1000));
    return isNaN(d) ? '' : d.toISOString().slice(0,10);
  }
  // ISO / locale strings
  const d = new Date(v);
  return isNaN(d) ? '' : d.toISOString().slice(0,10);
}
function num(v){ if(v==null)return 0; if(typeof v==='number')return v||0; const n=parseFloat(String(v).replace(/[,$%\s]/g,'')); return isNaN(n)?0:n; }
function normName(v){ return String(v||'').toLowerCase().replace(/\s+/g,' ').trim(); }

const ROLES=['Campaigns 30 Days','Campaigns 7 Days','Day Before Yesterday','Yesterday'];
const fileInput=document.getElementById('allFiles');

function syncExclusiveSelections(){
  const selects=[...document.querySelectorAll('#fileAssignments select[multiple]')];
  const selectedElse=new Set();
  selects.forEach(s=>[...s.selectedOptions].forEach(o=>selectedElse.add(o.value)));
  selects.forEach(s=>{
    const own=new Set([...s.selectedOptions].map(o=>o.value));
    [...s.options].forEach(o=>o.disabled=selectedElse.has(o.value)&&!own.has(o.value));
    s.classList.toggle('has-selection',own.size>0);
  });
}

fileInput.addEventListener('change',()=>{
  const files=[...fileInput.files]; const container=document.getElementById('fileAssignments'); container.innerHTML='';
  ROLES.forEach(r=>{
    const wrap=document.createElement('div'); const lab=document.createElement('label'); lab.textContent=r;
    const sel=document.createElement('select'); sel.multiple=true; sel.dataset.role=r;
    sel.addEventListener('change',syncExclusiveSelections);
    files.forEach((f,i)=>{const o=document.createElement('option'); o.value=i; o.textContent=f.name; sel.appendChild(o);});
    wrap.appendChild(lab); wrap.appendChild(sel); container.appendChild(wrap);
  });
  syncExclusiveSelections();
});

function readFileAsync(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res({data:r.result,name:f.name});r.onerror=e=>rej(e);r.readAsArrayBuffer(f);});}

async function proceed(){
  setStatus('Working...'); log('Start processing');
  try{
    const selects=document.querySelectorAll('#fileAssignments select'); const all=fileInput.files; const filesMap={};
    selects.forEach(s=>{const idxs=[...s.selectedOptions].map(o=>o.value); if(idxs.length)filesMap[s.dataset.role]=idxs.map(i=>all[i]);});
    if(!filesMap['Campaigns 30 Days']) throw new Error('Campaigns 30 Days not assigned.');
    async function readMultiple(fs){const a=[];for(const f of fs||[]){try{const{data}=await readFileAsync(f);const wb=XLSX.read(data, {type:'array', cellDates: true });const sh=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:'', raw: false, dateNF: 'yyyy-mm-dd'});a.push(...sh);}catch(e){log(`Failed ${f.name}: ${e}`);}}return a;}
    const d30=await readMultiple(filesMap['Campaigns 30 Days']),d7=await readMultiple(filesMap['Campaigns 7 Days']),db=await readMultiple(filesMap['Day Before Yesterday']),y=await readMultiple(filesMap['Yesterday']);
    const TH={clicksNoSales:+thClicksNoSales.value||7,highAcos:(+thHighAcos.value||35)/100,lowAcos:(+thLowAcos.value||20)/100,lowClicks:+thLowClicks.value||2};
    const map7={},mapDB={},mapY={}; d7.forEach(r=>map7[normName(r['Campaigns'])]=r); db.forEach(r=>mapDB[normName(r['Campaigns'])]=r); y.forEach(r=>mapY[normName(r['Campaigns'])]=r);
    const out=[];
    d30.forEach(r=>{
      const k=normName(r['Campaigns']),r7=map7[k]||{},rDB=mapDB[k]||{},rY=mapY[k]||{};
      const row={
        'Campaigns':r['Campaigns']||'','Start date':formatDate(r['Start date'] || r['Start Date'] || r['StartDate']),
        'Portfolio':r['Portfolio']||r['Portifolio']||'','Budget':r['Budget']||0,
        'Impressions_30days':r['Impressions']||0,'Clicks_30days':r['Clicks']||0,'Spend_30days':r['Spend']||0,
        'Orders_30days':r['Orders']||0,'Sales_30days':r['Sales']||0,
        'ACOS_30days':r['ACOS']?(r['ACOS']>1?r['ACOS']/100:r['ACOS']):0,
        'Last 7 Days':'','Impressions_7days':num(r7['Impressions']),
        'Clicks_7days':num(r7['Clicks']),'Spend_7days':num(r7['Spend']),
        'Orders_7days':num(r7['Orders']),'Sales_7days':num(r7['Sales']),
        'ACOS_7days':(v=>{v=num(v);return v>1?v/100:v;})(r7['ACOS']),
        'Spent_DayBeforeYesterday':num(rDB['Spend']),'Spent_Yesterday':num(rY['Spend'])
      };
      const clicks7 = +row['Clicks_7days'],
      sales7 = +row['Sales_7days'],
      acos7 = +row['ACOS_7days'];

row['Budget Check'] = '';
row['Lower bids for Bleeders w/ no Sales'] = (clicks7 >= TH.clicksNoSales && sales7 === 0) ? 'TRUE' : 'FALSE';
row['Lower bids for targets w/ ACOS higher than'] = (acos7 > TH.highAcos) ? TH.highAcos : '';
row['Increase bids to Targets w/ Low Clicks'] = (clicks7 < TH.lowClicks) ? '3%' : '';
row['Increase bids for Targets with good ACOS'] = (acos7 > 0 && acos7 <= TH.lowAcos) ? '3%' : '';
// âœ… Updated line: ignore ACOS = 0
row['Crateria: Good ACOS'] = (acos7 > 0 && acos7 < TH.lowAcos) ? TH.lowAcos : '';
row['Change Campaign Budget'] = r['Change Campaign Budget'] || '';
out.push(row);

    });
    const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(out);
    const wsRange=XLSX.utils.decode_range(ws['!ref']); const headers=Object.keys(out[0]||{}); const headerMap={}; headers.forEach((h,i)=>headerMap[h]=i);
    function fmt(col){if(!(col in headerMap))return;const c=XLSX.utils.encode_col(headerMap[col]);for(let R=1;R<=wsRange.e.r;R++){const a=c+(R+1);const cell=ws[a];if(cell&&typeof cell.v==='number'){cell.t='n';cell.z='0.00%';}}}
    ['ACOS_30days','ACOS_7days','Lower bids for targets w/ ACOS higher than','Crateria: Good ACOS'].forEach(fmt);
    XLSX.utils.book_append_sheet(wb,ws,'Bidding');
    XLSX.writeFile(wb,'bidding.xlsx'); setStatus('Done â€” bidding.xlsx downloaded',true); log('Export completed');
  }catch(e){log('Error: '+e.message);setStatus('Error');}
}
document.getElementById('proceed').addEventListener('click',proceed);
</script>
</body>
</html>
