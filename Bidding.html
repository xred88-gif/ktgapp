<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bidding</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Inter font like the first file -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root { --bg:#0b1220; --panel:#121a2b; --ink:#e7ecf8; --muted:#9fb0d3; --accent:#7aa2ff; --ok:#2ecc71; --warn:#ffb020; }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    background: var(--bg);
    color: var(--ink);
  }

  .wrap{ max-width: 980px; margin: 40px auto; padding: 24px; }
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  }

  h1{ font-size:28px; margin:0 0 12px; }
  h3{ margin:22px 0 10px; }
  .help{ color: var(--muted); margin: 6px 0 16px; }
  .small{ font-size:12px; color: var(--muted); }

  label{ display:block; font-weight:600; margin:12px 0 6px; }
  input[type="file"], select, button, textarea{
    width:100%;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.12);
    background:#0f1626;
    color:var(--ink);
    outline:none;
  }
  textarea{ resize:vertical; min-height:180px; }

  input[type="file"]:focus, select:focus, button:focus, textarea:focus{
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(122,162,255,0.25);
  }

  .btn{ cursor:pointer; font-weight:700; letter-spacing:.2px; border:none; }
  .btn.primary{ background: linear-gradient(90deg, #5a82ff, #7aa2ff); }
  .btn.secondary{ background:#18223a; font-weight:600; }

  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  .mt{ margin-top:14px; }

  .status{ display:flex; gap:10px; align-items:center; margin-top:12px; color:var(--muted); }
  .dot{ width:10px; height:10px; border-radius:50%; background: var(--warn); }
  .dot.ok{ background: var(--ok); }

  footer{ margin-top:24px; color:var(--muted); font-size:12px; text-align:center; }
  code { background:#0f1626; padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.08); }
</style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h1>ðŸ“Š Amazon Bidding Report Creator</h1>
    <p class="help">Upload all Excel files at once. Assign each file to a role and click <strong>Proceed</strong> to produce <code>bidding.xlsx</code>.</p>

    <div class="mt">
      <label>Upload all Excel files</label>
      <input id="allFiles" type="file" accept=".xlsx,.xls" multiple />
    </div>

    <div id="fileAssignments" class="row mt"></div>

    <div class="row mt">
      <div>
        <button id="proceed" class="btn primary">Proceed</button>
      </div>
      <div class="status">
        <span class="dot" id="statusDot"></span>
        <span id="status"> </span>
      </div>
    </div>

    <h3 class="mt">Log data</h3>
    <textarea id="log" readonly></textarea>
  </div>

  <footer class="small">
  </footer>
</div>

<script>
function log(msg){
  const t=document.getElementById('log');
  t.value=(new Date()).toISOString()+' | '+msg+'\n'+t.value;
  console.log(msg);
}

function setStatus(text, ok=false){
  const s = document.getElementById('status');
  const d = document.getElementById('statusDot');
  s.textContent = text;
  if(ok){ d.classList.add('ok'); } else { d.classList.remove('ok'); }
}

function readFileAsync(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=e=>resolve({name:file.name,data:e.target.result});
    reader.onerror=e=>reject(e);
    reader.readAsArrayBuffer(file);
  });
}

function formatDate(val){
  if(!val) return '';
  if(typeof val==='number'){
    const d = new Date(Math.round((val - 25569)*86400*1000));
    return d.toISOString().split('T')[0];
  }
  return val;
}

// ---- File assignment dropdowns ----
document.getElementById('allFiles').addEventListener('change', e=>{
  const files = Array.from(e.target.files);
  const roles = ['Campaigns 30 Days','Campaigns 7 Days','Day Before Yesterday','Yesterday'];
  const container = document.getElementById('fileAssignments');
  container.innerHTML='';

  roles.forEach(role=>{
    const select=document.createElement('select');
    select.dataset.role=role;
    select.multiple=true;

    select.innerHTML = Array.from(files).map((f,i)=>`<option value="${i}">${f.name}</option>`).join('');

    const label=document.createElement('label');
    label.textContent=role;
    label.appendChild(select);

    const countSpan=document.createElement('span');
    countSpan.style.marginLeft='6px';
    countSpan.style.fontWeight='normal';
    countSpan.className='small';
    countSpan.textContent='(0 selected)';
    label.appendChild(countSpan);

    select.addEventListener('change', ()=>{
      const selectedCount = select.selectedOptions.length;
      countSpan.textContent=`(${selectedCount} selected)`;
      updateDropdowns();
    });

    container.appendChild(label);
  });

  function updateDropdowns(){
    const allSelects = container.querySelectorAll('select');
    const selectedIndices=[];
    allSelects.forEach(s=>{ selectedIndices.push(...Array.from(s.selectedOptions).map(o=>o.value)); });

    allSelects.forEach(s=>{
      const currentValues = Array.from(s.selectedOptions).map(o=>o.value);
      Array.from(s.options).forEach(opt=>{
        if(opt.value==='') return;
        opt.disabled = !currentValues.includes(opt.value) && selectedIndices.includes(opt.value);
      });
    });
  }
});

// ---- Main processing ----
async function proceed(){
  setStatus('Working...');
  log('Start processing');

  try{
    const selects=document.querySelectorAll('#fileAssignments select');
    const allFiles=document.getElementById('allFiles').files;
    const filesMap={};

    selects.forEach(sel=>{
      const idxs=Array.from(sel.selectedOptions).map(o=>o.value);
      if(idxs.length>0) filesMap[sel.dataset.role]=idxs.map(i=>allFiles[i]);
    });

    if(!filesMap['Campaigns 30 Days'] || filesMap['Campaigns 30 Days'].length===0){
      throw new Error('Campaigns 30 Days not assigned.');
    }

    log('Files assigned');

    // âœ… FIXED: use wb (lowercase b) and add guards/logs
    async function readMultiple(files){
      const allData=[];
      for(const f of (files||[])){
        try{
          const { data, name } = await readFileAsync(f);
          const wb = XLSX.read(data, { type:'array' });
          if(!wb.SheetNames || wb.SheetNames.length===0){
            log(`No sheets found in ${name}`);
            continue;
          }
          const firstSheet = wb.SheetNames[0];
          const sheet = wb.Sheets[firstSheet];
          if(!sheet){
            log(`Sheet "${firstSheet}" missing in ${name}`);
            continue;
          }
          const json = XLSX.utils.sheet_to_json(sheet, { defval:'' });
          log(`Loaded ${json.length} rows from ${name} (${firstSheet})`);
          allData.push(...json);
        }catch(e){
          log(`Failed to read ${f && f.name ? f.name : '(unknown)'}: ${e.message||e}`);
        }
      }
      return allData;
    }

    const data30 = await readMultiple(filesMap['Campaigns 30 Days']);
    const data7  = await readMultiple(filesMap['Campaigns 7 Days']||[]);
    const dayBefore = await readMultiple(filesMap['Day Before Yesterday']||[]);
    const yesterday = await readMultiple(filesMap['Yesterday']||[]);

    log('Files loaded');

    // Build quick lookup maps
    const map7={}, mapDB={}, mapY={};
    data7.forEach(r=>{ if(r && r['Campaigns']!=null) map7[r['Campaigns']]=r; });
    dayBefore.forEach(r=>{ if(r && r['Campaigns']!=null) mapDB[r['Campaigns']]=r; });
    yesterday.forEach(r=>{ if(r && r['Campaigns']!=null) mapY[r['Campaigns']]=r; });

    // Transform output
    const output=[];
    data30.forEach((r30)=>{
      const name=r30['Campaigns'];
      const r7 = map7[name]||{};
      const rDB= mapDB[name]||{};
      const rY = mapY[name]||{};

      const acos30 = r30['ACOS'];
      const acos7  = r7['ACOS'];

      output.push({
        'Campaigns': name||'',
        'Start date': formatDate(r30['Start date']),
        'Portfolio': r30['Portfolio']||r30['Portifolio']||'',
        'Budget': r30['Budget']||0,
        'Impressions_30days': r30['Impressions']||r30['Impression']||0,
        'Clicks_30days': r30['Clicks']||0,
        'Spend_30days': r30['Spend']||0,
        'Orders_30days': r30['Orders']||0,
        'Sales_30days': r30['Sales']||0,
        'ACOS_30days': acos30 ? (acos30 > 1 ? acos30/100 : acos30) : 0,
        'Last 7 Days': '',
        'Impressions_7days': r7['Impressions']||r7['Impression']||0,
        'Clicks_7days': r7['Clicks']||0,
        'Spend_7days': r7['Spend']||0,
        'Orders_7days': r7['Orders']||0,
        'Sales_7days': r7['Sales']||0,
        'ACOS_7days': acos7 ? (acos7 > 1 ? acos7/100 : acos7) : 0,
        'Spent_DayBeforeYesterday': rDB['Spend']||0,
        'Spent_Yesterday': rY['Spend']||0
      });
    });

    if(output.length===0){
      setStatus('No rows found in â€œCampaigns 30 Daysâ€ files â€” check your input.', false);
      log('No output rows. Stopping before export.');
      return;
    }

    // Build workbook
    const wbOut = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(output);

    // Percentage formatting for ACOS (guarded)
    if(ws && ws['!ref']){
      const wsRange = XLSX.utils.decode_range(ws['!ref']);
      const headers = Object.keys(output[0] || {});
      const headerMap = {};
      headers.forEach((h,i)=>headerMap[h]=i);

      const acos30Idx = headerMap['ACOS_30days'];
      const acos7Idx  = headerMap['ACOS_7days'];

      if(Number.isInteger(acos30Idx)){
        const col = XLSX.utils.encode_col(acos30Idx);
        for(let R=1; R<=wsRange.e.r; R++){
          const addr = col + (R+1);
          if(!ws[addr]) ws[addr] = { t:'n', v:0 };
          ws[addr].t='n';
          ws[addr].z='0.00%';
        }
      }

      if(Number.isInteger(acos7Idx)){
        const col = XLSX.utils.encode_col(acos7Idx);
        for(let R=1; R<=wsRange.e.r; R++){
          const addr = col + (R+1);
          if(!ws[addr]) ws[addr] = { t:'n', v:0 };
          ws[addr].t='n';
          ws[addr].z='0.00%';
        }
      }
    }

    XLSX.utils.book_append_sheet(wbOut, ws, 'Bidding');
    XLSX.writeFile(wbOut,'bidding.xlsx');
    setStatus('Done â€” bidding.xlsx downloaded', true);
    log('Export completed');

  }catch(err){
    console.error(err);
    log('Error: '+(err.message||err));
    setStatus('Error');
  }
}

document.getElementById('proceed').addEventListener('click',proceed);
</script>

</body>
</html>
